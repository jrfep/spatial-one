{
  "hash": "4642dbeceb5477354d84bf2429ca491b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Exploring New South Wales from my Desktop\"\nsubtitle: \"Using NSW spatial service layers in R\"\nauthor: \"José R. Ferrer-Paris\"\ndate: \"2024-05-26\"\ncategories: [WMTS, R code, leaflet, Australia, iNaturalist]\nfrom: markdown+emoji\n---\n\n\n## JR the (virtual) explorer!\n\nBelieve it or not, I do not spend my whole time sitting in front of my Desktop computer. Sometimes I do get out and explore this wonderful country, look:\n\n\n![*Odontophora* observed in Maroubra NSW 2035, Australia by [neomapas@iNaturalist](https://www.inaturalist.org/observations/57196283)](https://inaturalist-open-data.s3.amazonaws.com/photos/91213188/medium.jpeg){height=150 group=\"my-gallery\" .lightbox .preview-image} ![*Silver Gull* observed in Sydney NSW, Australia by [neomapas@iNaturalist](https://www.inaturalist.org/observations/169753075)](https://inaturalist-open-data.s3.amazonaws.com/photos/294331887/medium.jpeg){height=150 group=\"my-gallery\" .lightbox .preview-image} ![** observed in Wentworth St, Randwick, NSW, AU by [neomapas@iNaturalist](https://www.inaturalist.org/observations/170737867)](https://inaturalist-open-data.s3.amazonaws.com/photos/296176868/medium.jpg){height=150 group=\"my-gallery\" .lightbox .preview-image} ![*Laughing Kookaburra* observed in Prince Street, Randwick, NSW, AU by [neomapas@iNaturalist](https://www.inaturalist.org/observations/92708387)](https://inaturalist-open-data.s3.amazonaws.com/photos/153542177/medium.jpg){height=150 group=\"my-gallery\" .lightbox .preview-image} ![*Schoenus subaphyllus* observed in Scotia NSW 2648, Australia by [neomapas@iNaturalist](https://www.inaturalist.org/observations/207557672)](https://inaturalist-open-data.s3.amazonaws.com/photos/367151756/medium.jpeg){height=150 group=\"my-gallery\" .lightbox .preview-image} ![*Exoneura* observed in Karloo Pools Walking Track W, Royal Nat'l Park NSW 2233, Australia by [neomapas@iNaturalist](https://www.inaturalist.org/observations/169920465)](https://inaturalist-open-data.s3.amazonaws.com/photos/294639693/medium.jpeg){height=150 group=\"my-gallery\" .lightbox .preview-image} ![*Leafy Purple Flag* observed in La Perouse, Sydney NSW, Australia by [neomapas@iNaturalist](https://www.inaturalist.org/observations/169910476)](https://inaturalist-open-data.s3.amazonaws.com/photos/294622118/medium.jpeg){height=150 group=\"my-gallery\" .lightbox .preview-image} ![*Purple Rock Crab* observed in Manly NSW 2095, Australia by [neomapas@iNaturalist](https://www.inaturalist.org/observations/169910871)](https://inaturalist-open-data.s3.amazonaws.com/photos/294622735/medium.jpeg){height=150 group=\"my-gallery\" .lightbox .preview-image} ![*Lesser Grass Blue* observed in Sydney NSW, Australia by [neomapas@iNaturalist](https://www.inaturalist.org/observations/169749561)](https://inaturalist-open-data.s3.amazonaws.com/photos/294325114/medium.jpeg){height=150 group=\"my-gallery\" .lightbox .preview-image} ![*Red and Blue Beetle* observed in Scotia NSW 2648, Australia by [neomapas@iNaturalist](https://www.inaturalist.org/observations/207557673)](https://inaturalist-open-data.s3.amazonaws.com/photos/367152049/medium.jpeg){height=150 group=\"my-gallery\" .lightbox .preview-image} ![*Milky Flower Spider* observed in Karloo Pools Walking Track W, Royal Nat'l Park NSW 2233, Australia by [neomapas@iNaturalist](https://www.inaturalist.org/observations/169920463)](https://inaturalist-open-data.s3.amazonaws.com/photos/294639647/medium.jpeg){height=150 group=\"my-gallery\" .lightbox .preview-image} ![*White-browed Scrubwren* observed in Blue Mountains Nat'l Park NSW 2787, Australia by [neomapas@iNaturalist](https://www.inaturalist.org/observations/172062273)](https://inaturalist-open-data.s3.amazonaws.com/photos/298640585/medium.jpeg){height=150 group=\"my-gallery\" .lightbox .preview-image}\n\n\nBut yeah, most of the time I am **exploring the world through geospatial data**. And since I am clearly obsessed with reproducible workflows, I want to code my way through the process, and make sure I can produce the building blocks for future virtual explorations.\n\nSo I asked myself this question, How do I make a good base map for exploring New South Wales (Australia) in as few lines of code as possible? Well it seems [NSW Spatial Services](https://www.spatial.nsw.gov.au) has the data that I need! \n\nToday I will create a minimal example for creating a dynamic map using these layers, R and the `leaflet` package.\n\n## Data from Spatial NSW\n\nIf you navigate from the NSW Spatial Services to the [Web services](https://www.spatial.nsw.gov.au/products_and_services/web_services) pages you will find that:\n\n> Web services are released under open access licences as part of the NSW Government Open Data Policy to support new and innovative uses of NSW Government digital information.\n\nThat is great, lets do some new and innovative uses of the digital information!\n\nThere are many [data in different themes](https://portal.spatial.nsw.gov.au/portal/apps/sites/#/homepage/pages/nsw-data-themes) to choose from: Imagery, Land Cover, Physiography...\n\nThe documentation in their webpage focuses on two supported protocols here REST API and WMS, and the favourite GIS software of many users. But what about the few of us with different taste?. I though my use case would fall within the [Advanced User Guide](https://www.spatial.nsw.gov.au/products_and_services/web_services/advancedguide), but it seems I still needed to sort out many details to get it to work in R using the `leaflet` package. \n\n## This is how it's done\n\nShort and sweet in as few lines of code as possible:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Have you met Leaflet.JS?\nlibrary(leaflet)\n\n# URL for the MapServer\nNSW_basemap_url <- \n    \"http://maps.six.nsw.gov.au/arcgis/rest/services/public/NSW_Base_Map/MapServer/WMTS\"\n\n# Build a request for the server\nNSW_basemap_layer <- \"&layer=public_NSW_Base_Map\"\n\nnsw_basemap <- paste0(\n    NSW_basemap_url,\n    \"?Request=GetTile\",\n    \"&Service=WMTS\",\n    \"&Version=1.0.0\",\n    \"&Style=default\",\n    \"&tilematrixset=default028mm\",\n    \"&Format=image/jpgpng\",\n    NSW_basemap_layer,\n    \"&TileMatrix={z}\",\n    \"&TileRow={y}\",\n    \"&TileCol={x}\"\n  )\n\n# Don't forget the attribution\nattrib_string <- \n    sprintf(\" © State of New South Wales, Department of Customer Service, Spatial Services %s\", \n    date()\n)\n\n# Create a map with this tile set\nleaflet() |>\n    setView(lng = 151.2365, lat = -33.916, zoom = 15) |>\n    addTiles(urlTemplate = nsw_basemap,\n           attribution = attrib_string,\n           group = 'NSW basemap'\n           ) \n```\n:::\n\n\n## Code explained\n\nOk, now let's go over the code and describe the steps in more detail. This will help you understand the process better and provide more info on how to adapt this example to your needs.\n\n### Have you met Leaflet.JS?\n\nI have probably said this before, but **Leaflet JS** <https://leafletjs.com/> is probably the most popular open-source JavaScript library for mobile- and web-friendly interactive maps. With an easy to use and well-documented API, many developers have contributed libraries, modules, plug-ins and interfaces to implement leaflet maps from your favourite programming languages and development platforms. Here we are using the R package <https://rstudio.github.io/leaflet/> to integrate these JS functions in R.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(leaflet)\n```\n:::\n\n\n### URL for the MapServer\n\nWe need the address of the MapServer that hold the layer we want to display. This step is not as easy as it should be, but with patience you will get there. The spatial portal has so many levels of information, you can easily click around in circles without getting the info you need. \n\nSo here is one possible way **NOT** to get there:\n\n- Start at https://www.spatial.nsw.gov.au\n    - Click on [NSW Spatial Collaboration Portal](https://portal.spatial.nsw.gov.au/portal/apps/sites/#/homepage)\n        - Go to [Browse Data](https://portal.spatial.nsw.gov.au/portal/apps/sites/#/homepage/pages/nsw-data-themes)\n            - Select a theme, for example [Imagery and Landcover](https://portal.spatial.nsw.gov.au/portal/home/search.html?q=&start=1&num=20&sortField=numviews)\n                - Within the theme, select the web map you want, for example [NSW Imagery Basemap Service](https://portal.spatial.nsw.gov.au/portal/home/item.html?id=ae273ee6312d4e1e83ee7b3a9565abdf)\n                    - You can see this is getting silly, click on the 'Open in Map Viewer' and despair...\n\nSo finally we have the URL:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# URL for the MapServer\nNSW_basemap_url <- \n    \"http://maps.six.nsw.gov.au/arcgis/rest/services/public/NSW_Base_Map/MapServer/WMTS\"\n```\n:::\n\n\n### Build a request for the server\n\nNow we need to build a request for the server.\n\nThis starts with getting the capabilities of the server by visiting this url in a browser:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npaste0(NSW_basemap_url, \"?Request=GetCapabilities\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"http://maps.six.nsw.gov.au/arcgis/rest/services/public/NSW_Base_Map/MapServer/WMTS?Request=GetCapabilities\"\n```\n\n\n:::\n:::\n\n\nYou will get a document in XML format that has the information we need for the next request. \n\nFor example the layer identifier:\n\n```xml\n<Layer>\n<ows:Title>public_NSW_Base_Map</ows:Title>\n<ows:Identifier>public_NSW_Base_Map</ows:Identifier>\n...\n```\n\nAlso Style:\n\n```xml\n<Style isDefault=\"true\">\n<ows:Title>Default Style</ows:Title>\n<ows:Identifier>default</ows:Identifier>\n</Style>\n```\n\nAnd others...\n\nAnd then we concatenate the mapserver url and the layer name with a couple of parameters needed in our WMTS `GetTile` request:\n\n::: {.cell}\n\n```{.r .cell-code}\nnsw_basemap <- paste0(\n    NSW_basemap_url,\n    # Service (version) request \n    \"?Service=WMTS\", \n    \"&Request=GetTile\", \n    \"&Version=1.0.0\", \n    # the following need to match the details in the GetCapabbilities request\n    \"&Style=default\", # usually there is only one style\n    \"&tilematrixset=default028mm\", # usually default028mm or GoogleMapsCompatible\n    \"&Format=image/png\", # check the available format, sometime it is image/jpgpng\n    \"&layer=public_NSW_Base_Map\", # check the name of the layer\n    # The x,y,z dimensions dynamically requested\n    # based on the zoom and coordinates of the viewer window\n    \"&TileMatrix={z}\", \n    \"&TileRow={y}\",\n    \"&TileCol={x}\"\n  )\n```\n:::\n\n\n\n### Don't forget the attribution\n\n::: {.cell}\n\n```{.r .cell-code}\nattrib_string <- \n    sprintf(\" © State of New South Wales, Department of Customer Service, Spatial Services %s\", \n    date()\n)\n```\n:::\n\n\n### Create a map with this tile set\n\n\n::: {.cell}\n\n```{.r .cell-code}\nleaflet() |>\n    setView(lng = 151.2365, lat = -33.916, zoom = 15) |>\n    addTiles(urlTemplate = nsw_basemap,\n           attribution = attrib_string,\n           group = 'NSW basemap'\n           ) \n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-d6cde2040a7e72eeed29\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-d6cde2040a7e72eeed29\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"setView\":[[-33.916,151.2365],15,[]],\"calls\":[{\"method\":\"addTiles\",\"args\":[\"http://maps.six.nsw.gov.au/arcgis/rest/services/public/NSW_Base_Map/MapServer/WMTS?Service=WMTS&Request=GetTile&Version=1.0.0&Style=default&tilematrixset=default028mm&Format=image/png&layer=public_NSW_Base_Map&TileMatrix={z}&TileRow={y}&TileCol={x}\",null,\"NSW basemap\",{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\" © State of New South Wales, Department of Customer Service, Spatial Services Sun May 26 16:03:26 2024\"}]}]},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n## And here some bonus tips\n\n### Other layers from same base URL :grinning:\n\nNow that this is working, I got curious about other layers available in the same portal. \n\nSome of the sources have the same base url and we just need to change the name of the layer, for example we can use a function in package `stringr` to replace the base map with imagery: \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(stringr)\nnsw_imagery <- str_replace_all(nsw_basemap, \"NSW_Base_Map\", \"NSW_Imagery\") \nleaflet() |>\n  setView(lng = 151.2365, lat = -33.916, zoom = 14) |>\n  addTiles(urlTemplate = nsw_imagery,\n           attribution = attrib_string\n           ) \n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-0c09dcffc3557074bd6d\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-0c09dcffc3557074bd6d\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"setView\":[[-33.916,151.2365],14,[]],\"calls\":[{\"method\":\"addTiles\",\"args\":[\"http://maps.six.nsw.gov.au/arcgis/rest/services/public/NSW_Imagery/MapServer/WMTS?Service=WMTS&Request=GetTile&Version=1.0.0&Style=default&tilematrixset=default028mm&Format=image/png&layer=public_NSW_Imagery&TileMatrix={z}&TileRow={y}&TileCol={x}\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\" © State of New South Wales, Department of Customer Service, Spatial Services Sun May 26 16:03:26 2024\"}]}]},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n### Other layers from other base URL :confused:\n\nI also found historical aerial photographs, but the base url is different and for some reason I have been unable to create a request that works in leaflet, this code seems to be right, but the result is blank:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnsw_historical <- paste0(\n    \"https://portal.spatial.nsw.gov.au/tileservices/Hosted/HistoricalImagery1947/MapServer/\",\n    \"WMTS?\",\n    \"Request=GetTile\",\n    \"&Service=WMTS\",\n    \"&Version=1.0.0\",\n    \"&Style=default\",\n    \"&tilematrixset=default028mm\",\n    \"&Format=image/jpgpng\",\n    \"&layer=HistoricalImagery1947\",\n    \"&TileMatrix={z}\",\n    \"&TileRow={y}\",\n    \"&TileCol={x}\"\n  )\nleaflet() |>\n  setView(lng = 151.2365, lat = -33.916, zoom = 14) |>\n  addTiles(urlTemplate = nsw_historical,\n           attribution = attrib_string\n           ) \n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-4167e1d119ef12d7cdca\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-4167e1d119ef12d7cdca\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"setView\":[[-33.916,151.2365],14,[]],\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://portal.spatial.nsw.gov.au/tileservices/Hosted/HistoricalImagery1947/MapServer/WMTS?Request=GetTile&Service=WMTS&Version=1.0.0&Style=default&tilematrixset=default028mm&Format=image/jpgpng&layer=HistoricalImagery1947&TileMatrix={z}&TileRow={y}&TileCol={x}\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\" © State of New South Wales, Department of Customer Service, Spatial Services Sun May 26 16:03:26 2024\"}]}]},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\nThere are also some datsets using *Vector tile layers*, for example:\n\n```sh\nhttps://portal.spatial.nsw.gov.au/vectortileservices/rest/services/Hosted/NSW_BaseMap_VectorTile_Hybrid/VectorTileServer\n```\n\nI haven't yet figured out how to add them in Leaflet.\n\n\n### Multiple layers in one map :globe_with_meridians:\n\nNow we have at least two base layers, and we would like to display both in a map. We can do that with help of the `addLayersControl` function using the argument `baseGroups` to identify the groups of layers to choose from:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nleaflet() |>\n  setView(lng = 151.2365, lat = -33.916, zoom = 14) |>\n  addTiles(urlTemplate = nsw_basemap,\n           attribution = attrib_string,\n           group = 'NSW base map'\n           ) |>\n   addTiles(urlTemplate = nsw_imagery,\n           attribution = attrib_string,\n           group = 'NSW imagery'\n           ) |>\n    addLayersControl(\n        baseGroups = c(\"NSW imagery\", \"NSW base map\"))\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-8dee2b16b462eaed8224\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-8dee2b16b462eaed8224\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"setView\":[[-33.916,151.2365],14,[]],\"calls\":[{\"method\":\"addTiles\",\"args\":[\"http://maps.six.nsw.gov.au/arcgis/rest/services/public/NSW_Base_Map/MapServer/WMTS?Service=WMTS&Request=GetTile&Version=1.0.0&Style=default&tilematrixset=default028mm&Format=image/png&layer=public_NSW_Base_Map&TileMatrix={z}&TileRow={y}&TileCol={x}\",null,\"NSW base map\",{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\" © State of New South Wales, Department of Customer Service, Spatial Services Sun May 26 16:03:26 2024\"}]},{\"method\":\"addTiles\",\"args\":[\"http://maps.six.nsw.gov.au/arcgis/rest/services/public/NSW_Imagery/MapServer/WMTS?Service=WMTS&Request=GetTile&Version=1.0.0&Style=default&tilematrixset=default028mm&Format=image/png&layer=public_NSW_Imagery&TileMatrix={z}&TileRow={y}&TileCol={x}\",null,\"NSW imagery\",{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\" © State of New South Wales, Department of Customer Service, Spatial Services Sun May 26 16:03:26 2024\"}]},{\"method\":\"addLayersControl\",\"args\":[[\"NSW imagery\",\"NSW base map\"],[],{\"collapsed\":true,\"autoZIndex\":true,\"position\":\"topright\"}]}]},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n## Conclusion\n\nHere we use R and leaflet to load geospatial layers using WMTS services. Thanks to NSW Spatial service for the awesome products!\n\nHere the basic recipe:\n\n- Find the WMTS server,\n- Send a `GetCapabilities` request\n- Identify the layer of interest and other parameters,\n- Build your WMTS request, \n- Add the layer to your leaflet map using the `addTile` function\n- Optional:\n   - Repeat with other layers\n   - Add a layers control with `addLayersControl` function\n- Done!\n\nI hope this makes it easier for you to create your maps visualisations with R. Enjoy!\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../../site_libs/leaflet-1.3.1/leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/leaflet-1.3.1/leaflet.js\"></script>\n<link href=\"../../site_libs/leafletfix-1.0.0/leafletfix.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/proj4-2.6.2/proj4.min.js\"></script>\n<script src=\"../../site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js\"></script>\n<link href=\"../../site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/leaflet-binding-2.2.1/leaflet.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}